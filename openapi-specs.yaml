openapi: 3.0.3
info:
  title: E-Commerce Product Enrichment API
  description: Automatización de enriquecimiento de productos con IA
  version: 1.0.0
  contact:
    email: admin@orquestia.io

servers:
  - url: http://localhost:8000
    description: Backend Principal (Development)
  - url: http://localhost:8001
    description: Microservicio IA (Development)

tags:
  - name: Products
    description: Gestión de productos (Backend Principal)
  - name: AI Generation
    description: Generación de contenido con IA (Microservicio IA)
  - name: Health
    description: Health checks de servicios

paths:
  /products:
    post:
      tags:
        - Products
      summary: Crear producto con enriquecimiento IA
      operationId: createProduct
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateProductRequest'
            example:
              name: "Camiseta Algodón Premium"
              keywords: ["rojo", "algodón", "verano", "casual", "manga corta"]
              stock: 50
      responses:
        '201':
          description: Producto creado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductResponse'
              example:
                id: "123e4567-e89b-12d3-a456-426614174000"
                name: "Camiseta Algodón Premium"
                keywords: ["rojo", "algodón", "verano", "casual", "manga corta"]
                stock: 50
                description: "Camiseta de algodón 100% premium en vibrante color rojo, perfecta para el verano. Diseño casual y cómodo con manga corta, ideal para cualquier ocasión informal."
                category: "Ropa > Hombre > Camisetas"
                created_at: "2025-11-08T10:30:00Z"
                updated_at: "2025-11-08T10:30:00Z"
        '400':
          description: Datos inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "validation_error"
                message: "El campo 'stock' debe ser mayor a 0"
                details:
                  field: "stock"
                  constraint: "min_value"
        '503':
          description: Servicio IA no disponible
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "service_unavailable"
                message: "El microservicio de IA no está respondiendo"
                retry_after: 60

    get:
      tags:
        - Products
      summary: Listar productos
      operationId: listProducts
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
            minimum: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
            minimum: 1
            maximum: 500
      responses:
        '200':
          description: Lista de productos
          content:
            application/json:
              schema:
                type: object
                properties:
                  products:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProductResponse'
                  total:
                    type: integer
                    description: Total de productos en la base de datos
                  page:
                    type: integer
                  limit:
                    type: integer
              example:
                products:
                  - id: "123e4567-e89b-12d3-a456-426614174000"
                    name: "Camiseta Algodón Premium"
                    keywords: ["rojo", "algodón", "verano"]
                    stock: 50
                    description: "Camiseta de algodón 100% premium..."
                    category: "Ropa > Hombre > Camisetas"
                    created_at: "2025-11-08T10:30:00Z"
                    updated_at: "2025-11-08T10:30:00Z"
                  - id: "223e4567-e89b-12d3-a456-426614174001"
                    name: "Audífonos Bluetooth"
                    keywords: ["negro", "inalámbrico", "noise-cancelling"]
                    stock: 8
                    description: "Audífonos premium con cancelación de ruido..."
                    category: "Electrónica > Audio > Audífonos"
                    created_at: "2025-11-08T11:00:00Z"
                    updated_at: "2025-11-08T11:15:00Z"
                total: 2
                page: 1
                limit: 100
        '500':
          description: Error de base de datos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /products/{id}/sell:
    post:
      tags:
        - Products
      summary: Vender producto (decrementar stock)
      description: Simula venta y dispara alerta si stock < 10
      operationId: sellProduct
      parameters:
        - name: id
          in: path
          required: true
          description: UUID del producto
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Venta procesada exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  name:
                    type: string
                  stock:
                    type: integer
                    description: Stock actualizado después de la venta
                  low_stock_alert_sent:
                    type: boolean
              example:
                id: "123e4567-e89b-12d3-a456-426614174000"
                name: "Audífonos Bluetooth"
                stock: 7
                low_stock_alert_sent: true
        '404':
          description: Producto no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "not_found"
                message: "Producto con id '123e4567...' no existe"
        '400':
          description: Stock insuficiente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "insufficient_stock"
                message: "No hay stock disponible para este producto"
                current_stock: 0

  /health:
    get:
      tags:
        - Health
      summary: Health check
      operationId: healthCheck
      responses:
        '200':
          description: Servicio saludable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: "healthy"
                service: "backend-principal"
                version: "1.0.0"
                timestamp: "2025-11-08T10:30:00Z"
                dependencies:
                  database: "ok"
                  ia_service: "ok"
        '503':
          description: Servicio degradado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: "degraded"
                service: "backend-principal"
                version: "1.0.0"
                timestamp: "2025-11-08T10:30:00Z"
                dependencies:
                  database: "ok"
                  ia_service: "error - timeout after 5s"

  # ============================================
  # MICROSERVICIO IA - GENERATION ENDPOINTS
  # ============================================
  
  /generate/description:
    post:
      tags:
        - AI Generation
      summary: Generar descripción de producto
      operationId: generateDescription
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateDescriptionRequest'
            example:
              name: "Smartwatch Deportivo"
              keywords: ["GPS", "resistente al agua", "monitor cardíaco", "batería 7 días"]
      responses:
        '200':
          description: Descripción generada exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerateDescriptionResponse'
              example:
                generated_description: "Smartwatch deportivo de última generación con GPS integrado y resistencia al agua IP68. Monitorea tu ritmo cardíaco 24/7 y disfruta de hasta 7 días de batería con una sola carga. Perfecto para atletas y entusiastas del fitness que buscan superar sus límites."
                processing_time: 3.2
                model_used: "gpt-4-turbo"
                tokens_used: 87
        '400':
          description: Request inválido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Error en LLM API
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "llm_api_error"
                message: "OpenAI API returned 429: Rate limit exceeded"
        '504':
          description: Timeout
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "timeout"
                message: "LLM request exceeded 30s timeout"

  /generate/category:
    post:
      tags:
        - AI Generation
      summary: Clasificar producto en categoría
      description: Retorna categoría en formato jerárquico (ej. Electrónica > Audio > Audífonos)
      operationId: generateCategory
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateCategoryRequest'
            example:
              product_name: "Smartwatch Deportivo"
              description: "Smartwatch deportivo con GPS integrado y monitor cardíaco..."
      responses:
        '200':
          description: Categoría sugerida
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerateCategoryResponse'
              example:
                suggested_category: "Electrónica > Wearables > Smartwatches"
                confidence: 0.95
                processing_time: 2.1
                model_used: "gpt-4-turbo"
        '400':
          description: Request inválido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Error en LLM API
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

# ============================================
# COMPONENTS / SCHEMAS
# ============================================

components:
  schemas:
    CreateProductRequest:
      type: object
      required:
        - name
        - keywords
        - stock
      properties:
        name:
          type: string
          minLength: 3
          maxLength: 200
          example: "Camiseta Algodón Premium"
        keywords:
          type: array
          items:
            type: string
          minItems: 1
          maxItems: 10
          example: ["rojo", "algodón", "verano", "casual"]
        stock:
          type: integer
          minimum: 0
          example: 50

    ProductResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        keywords:
          type: array
          items:
            type: string
        stock:
          type: integer
        description:
          type: string
        category:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    GenerateDescriptionRequest:
      type: object
      required:
        - name
        - keywords
      properties:
        name:
          type: string
          minLength: 3
          maxLength: 200
          example: "Smartwatch Deportivo"
        keywords:
          type: array
          items:
            type: string
          minItems: 1
          example: ["GPS", "resistente al agua", "monitor cardíaco"]

    GenerateDescriptionResponse:
      type: object
      properties:
        generated_description:
          type: string
        processing_time:
          type: number
          format: float
        model_used:
          type: string
          example: "gpt-4-turbo"
        tokens_used:
          type: integer

    GenerateCategoryRequest:
      type: object
      required:
        - product_name
        - description
      properties:
        product_name:
          type: string
          example: "Smartwatch Deportivo"
        description:
          type: string
          example: "Smartwatch con GPS y monitor cardíaco..."

    GenerateCategoryResponse:
      type: object
      properties:
        suggested_category:
          type: string
          example: "Electrónica > Wearables > Smartwatches"
        confidence:
          type: number
          format: float
          minimum: 0
          maximum: 1
        processing_time:
          type: number
          format: float
        model_used:
          type: string

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        service:
          type: string
        version:
          type: string
        timestamp:
          type: string
          format: date-time
        dependencies:
          type: object
          additionalProperties:
            type: string

    Error:
      type: object
      properties:
        error:
          type: string
          example: "validation_error"
        message:
          type: string
          example: "El campo 'stock' es requerido"
        details:
          type: object
          additionalProperties: true
        retry_after:
          type: integer

  # ============================================
  # WEBHOOKS
  # ============================================
  
  webhooks:
    lowStockAlert:
      post:
        summary: Alerta de stock bajo
        description: Webhook disparado cuando stock < 10 después de venta
        requestBody:
          required: true
          content:
            application/json:
              schema:
                type: object
                required:
                  - product_id
                  - product_name
                  - current_stock
                properties:
                  product_id:
                    type: string
                    format: uuid
                  product_name:
                    type: string
                  current_stock:
                    type: integer
                  timestamp:
                    type: string
                    format: date-time
              example:
                product_id: "123e4567-e89b-12d3-a456-426614174000"
                product_name: "Audífonos Bluetooth"
                current_stock: 7
                timestamp: "2025-11-08T10:30:00Z"
        responses:
          '200':
            description: Webhook recibido por n8n
          '500':
            description: Error procesando webhook
