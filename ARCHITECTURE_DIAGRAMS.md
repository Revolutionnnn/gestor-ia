# ğŸ—ï¸ Arquitectura Refactorizada - Diagrama de Flujo

## ğŸ¯ Microservicio IA

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MICROSERVICIO IA                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚ main.py  â”‚  â—„â”€â”€â”€â”€ Entry Point (55 lÃ­neas)                â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”œâ”€â”€â”€â”€â”€â–º config.py      (ConfiguraciÃ³n + Logging)      â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”œâ”€â”€â”€â”€â”€â–º routes.py      (Endpoints HTTP)               â”‚
â”‚       â”‚         â”‚                                            â”‚
â”‚       â”‚         â”œâ”€â–º /health                                 â”‚
â”‚       â”‚         â”œâ”€â–º /generate/description                   â”‚
â”‚       â”‚         â””â”€â–º /generate/category                      â”‚
â”‚       â”‚              â”‚                                       â”‚
â”‚       â”‚              â–¼                                       â”‚
â”‚       â”œâ”€â”€â”€â”€â”€â–º llm_service.py (LÃ³gica LLM)                  â”‚
â”‚       â”‚         â”‚                                            â”‚
â”‚       â”‚         â”œâ”€â–º LLMService.generate()                   â”‚
â”‚       â”‚         â”œâ”€â–º _generate_openai()                      â”‚
â”‚       â”‚         â””â”€â–º _generate_gemini()                      â”‚
â”‚       â”‚              â”‚                                       â”‚
â”‚       â”‚              â–¼                                       â”‚
â”‚       â”œâ”€â”€â”€â”€â”€â–º prompts.py     (Templates)                    â”‚
â”‚       â”‚         â”œâ”€â–º build_description_prompt()              â”‚
â”‚       â”‚         â””â”€â–º build_category_prompt()                 â”‚
â”‚       â”‚                                                      â”‚
â”‚       â””â”€â”€â”€â”€â”€â–º models.py      (Pydantic Schemas)             â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸª Backend Principal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BACKEND PRINCIPAL                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                   â”‚
â”‚  â”‚ main.py  â”‚  â—„â”€â”€â”€â”€ Entry Point (40 lÃ­neas)                    â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                   â”‚
â”‚       â”‚                                                          â”‚
â”‚       â”œâ”€â”€â”€â”€â”€â–º config.py        (ConfiguraciÃ³n)                  â”‚
â”‚       â”œâ”€â”€â”€â”€â”€â–º constants.py     (Constantes negocio)             â”‚
â”‚       â”œâ”€â”€â”€â”€â”€â–º database.py      (SQLAlchemy)                     â”‚
â”‚       â”œâ”€â”€â”€â”€â”€â–º dependencies.py  (Dependencias)                   â”‚
â”‚       â”‚                                                          â”‚
â”‚       â”œâ”€â”€â”€â”€â”€â–º routes/                                           â”‚
â”‚       â”‚         â”œâ”€â–º health.py     GET  /health                  â”‚
â”‚       â”‚         â””â”€â–º products.py   POST /products                â”‚
â”‚       â”‚                          GET  /products                 â”‚
â”‚       â”‚                          POST /products/{id}/sell       â”‚
â”‚       â”‚              â”‚                                           â”‚
â”‚       â”‚              â–¼                                           â”‚
â”‚       â”œâ”€â”€â”€â”€â”€â–º services/                                         â”‚
â”‚       â”‚         â”‚                                               â”‚
â”‚       â”‚         â”œâ”€â–º product_service.py                          â”‚
â”‚       â”‚         â”‚     â”œâ”€â–º create_product()                      â”‚
â”‚       â”‚         â”‚     â”œâ”€â–º list_products()                       â”‚
â”‚       â”‚         â”‚     â”œâ”€â–º sell_product()                        â”‚
â”‚       â”‚         â”‚     â””â”€â–º needs_stock_alert()                   â”‚
â”‚       â”‚         â”‚                                               â”‚
â”‚       â”‚         â”œâ”€â–º alert_service.py                            â”‚
â”‚       â”‚         â”‚     â”œâ”€â–º send_low_stock_alert()                â”‚
â”‚       â”‚         â”‚     â”œâ”€â–º fetch_mock_price()                    â”‚
â”‚       â”‚         â”‚     â”œâ”€â–º generate_alert_message_with_ai()      â”‚
â”‚       â”‚         â”‚     â””â”€â–º print_alert_console()                 â”‚
â”‚       â”‚         â”‚                                               â”‚
â”‚       â”‚         â””â”€â–º ia_client.py                                â”‚
â”‚       â”‚               â”œâ”€â–º generate_description()  â”€â”€â”           â”‚
â”‚       â”‚               â””â”€â–º generate_category()       â”‚           â”‚
â”‚       â”‚                                             â”‚           â”‚
â”‚       â”œâ”€â”€â”€â”€â”€â–º models.py       (DB Models)           â”‚           â”‚
â”‚       â””â”€â”€â”€â”€â”€â–º schemas.py      (Pydantic)            â”‚           â”‚
â”‚                                                      â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                                            HTTP Request to
                                           Microservicio IA
```

## ğŸ”„ Flujo de CreaciÃ³n de Producto

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLIENT  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ POST /products
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Backend Principal                    â”‚
â”‚                                              â”‚
â”‚  routes/products.py                          â”‚
â”‚       â”‚                                      â”‚
â”‚       â–¼                                      â”‚
â”‚  ProductService.create_product()             â”‚
â”‚       â”‚                                      â”‚
â”‚       â”œâ”€â–º ia_client.generate_description() â”€â”¼â”€â”€â”
â”‚       â”‚                                      â”‚  â”‚
â”‚       â””â”€â–º ia_client.generate_category() â”€â”€â”€â”€â”¼â”€â”€â”¤
â”‚                                              â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                                  â”‚ HTTP
                                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Microservicio IA                       â”‚
â”‚                                                     â”‚
â”‚  routes.py                                          â”‚
â”‚       â”‚                                             â”‚
â”‚       â–¼                                             â”‚
â”‚  llm_service.generate()                             â”‚
â”‚       â”‚                                             â”‚
â”‚       â”œâ”€â–º prompts.build_description_prompt()        â”‚
â”‚       â””â”€â–º _generate_openai() / _generate_gemini()  â”‚
â”‚                  â”‚                                  â”‚
â”‚                  â–¼                                  â”‚
â”‚           OpenAI / Gemini API                       â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš¨ Flujo de Alerta de Stock Bajo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLIENT  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ POST /products/{id}/sell
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Backend Principal                     â”‚
â”‚                                               â”‚
â”‚  routes/products.py                           â”‚
â”‚       â”‚                                       â”‚
â”‚       â”œâ”€â–º get_product_or_404()                â”‚
â”‚       â”‚                                       â”‚
â”‚       â”œâ”€â–º ProductService.sell_product()       â”‚
â”‚       â”‚     â””â”€â–º product.stock -= 1            â”‚
â”‚       â”‚                                       â”‚
â”‚       â””â”€â–º ProductService.needs_stock_alert()  â”‚
â”‚             â”‚                                 â”‚
â”‚             â–¼ (if stock < threshold)          â”‚
â”‚       BackgroundTasks.add_task()              â”‚
â”‚             â”‚                                 â”‚
â”‚             â–¼                                 â”‚
â”‚  alert_service.send_low_stock_alert()         â”‚
â”‚       â”‚                                       â”‚
â”‚       â”œâ”€â–º fetch_mock_price()                  â”‚
â”‚       â”œâ”€â–º generate_alert_message_with_ai()    â”‚
â”‚       â”œâ”€â–º print_alert_console()               â”‚
â”‚       â””â”€â–º logger.warning()                    â”‚
â”‚                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ Capas de la Arquitectura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            PRESENTATION LAYER                â”‚  â—„â”€ Routes
â”‚  (HTTP Endpoints, Request/Response)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           BUSINESS LOGIC LAYER               â”‚  â—„â”€ Services
â”‚  (Product Service, Alert Service)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         DATA ACCESS LAYER                    â”‚  â—„â”€ Models, Database
â”‚  (SQLAlchemy Models, DB Operations)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       EXTERNAL SERVICES LAYER                â”‚  â—„â”€ IA Client, LLM
â”‚  (OpenAI, Gemini, External APIs)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ Ventajas de la Nueva Arquitectura

1. **Modularidad** ğŸ“¦
   - Cada mÃ³dulo tiene responsabilidad Ãºnica
   - FÃ¡cil de entender y mantener

2. **Testabilidad** ğŸ§ª
   - Servicios independientes
   - FÃ¡cil de mockear

3. **Escalabilidad** ğŸ“ˆ
   - Agregar features sin tocar cÃ³digo existente
   - Estructura preparada para crecer

4. **Mantenibilidad** ğŸ”§
   - Cambios localizados
   - Menos bugs

5. **Reusabilidad** â™»ï¸
   - Servicios compartidos
   - CÃ³digo DRY
